<!DOCTYPE html>
<html><head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" type="text/css" href="/css/default.css" />
</head>
<body><div id="nav">
  <p>
    <a href="/">home</a> | <a href="/index.xml">rss</a>
  </p>
</div>
<div id="content">
<h1 class="title">Mutable Constants</h1>
<div><p>Mutable constants are essentially constants initialized from mutable
variables.</p>
<p>For example, a constant in code but initialized from an environment
variable, which can be mutated before the constant is initialized to
affect it&rsquo;s value:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> Language LANG <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  Language<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">of</span><span style="color:#000;font-weight:bold">(</span>getEnv<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;LANG&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span></code></pre></div><p>Another example, this time it isn&rsquo;t a constant but it&rsquo;s intended to be
used like a constant after it&rsquo;s initial value is set by some
annotation processing library:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#3c5d5d;font-weight:bold">@Environment</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;LANG&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">private</span> <span style="color:#000;font-weight:bold">static</span> Language LANG<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span> Language <span style="color:#900;font-weight:bold">lang</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> LANG<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>There are undesired implications when code is written to use such
constants.</p>
<p>Take the following program that produces different results based on
the current <code>LANG</code> environment variable:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span> <span style="color:#000;font-weight:bold">final</span> Language LANG <span style="color:#000;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>  Language<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">of</span><span style="color:#000;font-weight:bold">(</span>getEnv<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;LANG&#34;</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">greet</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> LANG<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">translate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">...</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  println<span style="color:#000;font-weight:bold">(</span>greet<span style="color:#000;font-weight:bold">());</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>It&rsquo;s <strong>untestable</strong> as you can&rsquo;t unit test <code>greet()</code> with different
languages.  One may argue if <code>LANG</code> is made to be non-final, you can
change it&rsquo;s value in unit tests in order to test the <code>greet()</code>. This
basically turns it into a global variable, which is bad on it&rsquo;s own
levels, introduces concurrency problems, and you wouldn&rsquo;t be able to
test <code>greet()</code> with different languages <strong>in parallel</strong>.</p>
<p>It also puts a <strong>hidden dependency</strong> inside <code>greet()</code> that drives it&rsquo;s
behavior, not clear to the caller when looking at it&rsquo;s signature. In
the above example, each time you run the program, <code>greet()</code> may
produce a different result even though it&rsquo;s called with the same
parameters (in this example, empty). It makes <code>greet()</code> a bit magical,
and that&rsquo;s bad, a method&rsquo;s return value should be driven by the input
parameters, not by magic (There maybe exceptions, but this isn&rsquo;t one
of them).</p>
<p>Mutable constants should really be parameters instead:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span> String <span style="color:#900;font-weight:bold">greet</span><span style="color:#000;font-weight:bold">(</span>Language lang<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">return</span> lang<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">translate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">main</span><span style="color:#000;font-weight:bold">(</span>String<span style="color:#000;font-weight:bold">...</span> args<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  var env <span style="color:#000;font-weight:bold">=</span> getEnv<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;LANG&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  var lang <span style="color:#000;font-weight:bold">=</span> Language<span style="color:#000;font-weight:bold">.</span><span style="color:#008080">of</span><span style="color:#000;font-weight:bold">(</span>env<span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  println<span style="color:#000;font-weight:bold">(</span>greet<span style="color:#000;font-weight:bold">(</span>lang<span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This makes the code testable, testable in parallel, dependency is
clear, non-magical.</p>
</div>
<p class="date">2019-07-17</p>

        </div></body>
</html>
